<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chris Calendar</title>
    <style>
        /* General styles */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8f9fa;
            color: #333;
        }

        h1 {
            text-align: center;
            background-color: #007bff;
            color: white;
            margin: 0;
            padding: 15px;
        }

        #calendar-container {
            padding: 15px;
        }

        /* Styles for calendar */
        #calendar {
            display: block;
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }

        #calendar > div {
            display: block;
            margin-bottom: 10px;
            padding: 10px;
            background-color: #ffffff;
            text-align: center;
        }

        #calendar > div > div {
            display: block;
            padding: 8px;
            border-bottom: 1px solid #ddd;
        }

        .course {
            border: 1px solid #007bff;
            border-radius: 8px;
            display: block;
            padding-bottom: 4px;
            margin-bottom: 8px;
        }

        .course > p {
            font-weight: bold;
            margin: 4px;
        }

        #calendar > div > div:last-child {
            border-bottom: none;
        }

        .day-header {
            text-align: center;
            font-weight: bold;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            justify-content: space-between; /* Space out the child elements */
            align-items: center; /* Vertically center the elements */
            width: 100%; /* Ensure the header takes the full width */
        }

        .day-header > :first-child {
            margin-right: auto; /* Anchors the first element to the left */
        }

        .day-header > :nth-child(2) {
            margin-left: auto; /* Anchors the second element to the center */
        }

        #day-headers {
            display: none !important; /* Ensure day headers are hidden and take no space */
        }


        .collapse-btn {
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
        }

        .collapse-btn:hover {
            background-color: #0056b3;
        }

        .hidden-content {
            display: none;
        }

        .scroll-down {
            display: none;
        }

        select, input[type="button"] {
            padding: 8px;
            margin: 5px 0;
            width: 100%;
            box-sizing: border-box;
            font-size: 16px;
        }

        .filter-item {
            margin-bottom: 10px;
        }

        .collapse-btn {
            height: 32px;
        }

        label {
            font-weight: bold;
            display: block;
            padding: 6px;
        }
    </style>
</head>
<body>
<h1>Chris Supreme Calendar</h1>
<div id="calendar-container">
    Loading calendar...
</div>

<script>

    const btns = [];

    function getWeekNumber(d) {
        // Copy date so don't modify original
        d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
        // Set to nearest Thursday: current date + 4 - current day number
        // Make Sunday's day number 7
        d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
        // Get first day of year
        var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
        // Calculate full weeks to nearest Thursday
        var weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        // Return array of year and week number
        return weekNo;
    }

    async function fetchCalendar(location, week, type) {
        try {
            document.getElementById('calendar-container').innerText = 'Loading calendar...';
            console.log(`https://cors-anywhere.herokuapp.com/https://www.tanzschulechris.at/kalender_programm?tx_chilijsondata_chilijsondata%5Baction%5D=show&tx_chilijsondata_chilijsondata%5Bcontroller%5D=Sources&tx_chilijsondata_chilijsondata%5BfromAction%5D=search&tx_chilijsondata_chilijsondata%5BselectedLocation%5D=${location}&tx_chilijsondata_chilijsondata%5BselectedType%5D=${type}&tx_chilijsondata_chilijsondata%5BselectedWeek%5D=${week}`);
            const response = await fetch(`https://cors-anywhere.herokuapp.com/https://www.tanzschulechris.at/kalender_programm?tx_chilijsondata_chilijsondata%5Baction%5D=show&tx_chilijsondata_chilijsondata%5Bcontroller%5D=Sources&tx_chilijsondata_chilijsondata%5BfromAction%5D=search&tx_chilijsondata_chilijsondata%5BselectedLocation%5D=${location}&tx_chilijsondata_chilijsondata%5BselectedType%5D=${type}&tx_chilijsondata_chilijsondata%5BselectedWeek%5D=${week}`);

            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }

            const htmlText = await response.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlText, 'text/html');
            const calendarDiv = doc.querySelector('#calendar');

            const calendarContainer = document.getElementById('calendar-container');

            if (calendarDiv) {
                calendarContainer.innerHTML = calendarDiv.outerHTML;
                addCollapseFeature();
                document.querySelectorAll('select').forEach((item) => {
                    item.onchange = () => fetchCalendar(document.getElementById('location').value, document.getElementById('calendarweek').value, document.getElementById('type').value);
                });
                const btn = [...document.querySelectorAll('form > div > input')].filter(e => e.value == 'Suchen')[0];
                btn.type = 'button';
                btn.addEventListener('click', () => fetchCalendar(document.getElementById('location').value, document.getElementById('calendarweek').value, document.getElementById('type').value));

            } else {
                calendarContainer.textContent = 'Calendar not found in the response.';
            }
        } catch (error) {
            console.error('Error fetching calendar:', error);
            document.getElementById('calendar-container').textContent = 'Failed to load calendar.';
        }
    }

    function addCollapseFeature() {
        // Select all elements with the class "day-header"
        const dayHeaders = document.querySelectorAll('.day-header');

        const allButton = document.createElement('button');
        allButton.textContent = 'Hide All';
        allButton.classList.add('collapse-btn');
        const allToggle = () => {
            if (allButton.textContent === 'Show All') {
                allButton.textContent = 'Hide All';
                btns.forEach(btn => {
                    if (btn.textContent === 'Show') {
                        btn.click();
                    }
                });
                localStorage.removeItem('hideall');
            } else {
                allButton.textContent = 'Show All';
                btns.forEach(btn => {
                    if (btn.textContent === 'Hide') {
                        btn.click();
                    }
                });
                localStorage.setItem('hideall', '1');
            }

        };
        allButton.addEventListener('click', allToggle);
        dayHeaders[0].parentNode.parentNode.parentNode.prepend(allButton);

        dayHeaders.forEach(dayHeader => {
            if (dayHeader.parentElement.classList.contains('empty')) return;
            // Create a button for toggling visibility of "course" entries
            const toggleButton = document.createElement('button');
            toggleButton.textContent = 'Hide';
            toggleButton.classList.add('collapse-btn');

            // Insert the button before the first <p> element inside the "day-header"
            const firstParagraph = dayHeader.querySelector('p');
            if (firstParagraph.nextSibling) {
                dayHeader.insertBefore(toggleButton, firstParagraph.nextSibling);
            } else {
                dayHeader.appendChild(toggleButton);
            }

            const toggleCollapse = () => {
                let sibling = dayHeader.nextElementSibling;
                toggleButton.textContent = toggleButton.textContent !== 'Hide' ? 'Hide' : 'Show';

                // Loop through the following siblings
                while (sibling && sibling.classList.contains('course')) {
                    sibling.style.display = sibling.style.display === 'none' ? '' : 'none';
                    sibling = sibling.nextElementSibling;
                }
            }

            // Attach click event to toggle visibility of "course" entries
            toggleButton.addEventListener('click', toggleCollapse);
            btns.push(toggleButton);
        });
        if (localStorage.getItem('hideall')){
            allButton.click();
        } else {

        }
    }

    // Fetch calendar when the page loads
    fetchCalendar('3', ('0' + getWeekNumber(new Date())).slice(-2), '');


</script>
</body>
</html>
